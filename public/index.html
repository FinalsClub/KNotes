<!DOCTYPE HTML>
<html>
<head>
<meta charset="utf-8">
<!-- Bootstrap CSS Toolkit styles -->
<link rel="stylesheet" href="http://blueimp.github.com/cdn/css/bootstrap.min.css">
<title>Karma Notes</title>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
<script src="js/vendor/jquery.ui.widget.js"></script>
<script src="js/jquery.iframe-transport.js"></script>
<script src="js/jquery.fileupload.js"></script>
<!-- Le HTML5 shim, for IE6-8 support of HTML5 elements -->
<!--[if lt IE 9]>
  <script src="//html5shim.googlecode.com/svn/trunk/html5.js"></script>
<![endif]-->
<!-- Le fav and touch icons -->
<link href='http://fonts.googleapis.com/css?family=Architects+Daughter' rel='stylesheet' type='text/css'>
<link rel="shortcut icon" href="images/favicon.ico">
<link rel="apple-touch-icon" href="images/apple-touch-icon.png">
<link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
<style type="text/css">
  body{
    margin-top:60px;
    font-size: 18px;
  }
  a.btn{
    font-size:20px;
    
  }
  p{
    font-size:20px;
  }
  a:visited{
  }
  a:active{
  }
  a:hover {
  }
  .coursesOfSchool{
    margin-left: 20px;
    text-align:left;
  }
  .notesOfCourse{
    font-size:14px;
    margin-left: 40px;
    text-align:left;
  }
  .schoolBtn{
    font-size:18px;
    font-weight:bold;
    text-align:left;
  }
  #searchBySchool{
    width:500px;
    margin-left:auto;
    margin-right:auto;
    text-align:center;
  }
</style>
</head>

<body>
<div id="container" class="container-fluid" style="text-align:center" >
  <h1 style="font-family: 'Helvetica'; color:#025DB8;font-size:350%">Karma Notes</h1>    
  <h2 style="font-family: 'Helvetica';"><b>drop your notes below to share!</b></h2>

  <div id="drop-area" style="z-index:0;padding:10px;width:40%;margin:auto;position:relative;">
    <img src="http://karmanotes.org/img/ohm.svg" style="opacity:.1;width:300px"/>
  </div>
  
  <div id="browseForNotes">
    <div id="searchBySchool" style="padding:10px;text-align:center">
    </div><!-- searchBySchool -->
    <div id="searchByTags">
    </div>
  </div><!-- browseForNotes -->
  
  <div id="footer" style="padding:20px;">
    <p><a class="btn" id="notes-btn" >notes</a>
       <a class="btn" href="">profile</a>
       <a class="btn" href="">about</a>
    </p>
  </div><!-- footer -->
  
  <table id="file-list" style="background:#ffffff;opacity:1;width:70%;cell-padding:5px;margin-left:auto;margin-right:auto;margin-top:-320px;z-index:1">
  </table>
</div> <!-- /container -->

<!-- Also allow form file selection?
    <input class="btn" id="fileupload" type="file" name="files[]" multiple>
<div class="progress progress-striped active">
  <div class="bar" id="progress" style="width: 0%;"></div>
</div>
-->

<script>
$(document).ready(function() {
  $('#searchBySchool').hide();
  // get school and course info;
  $.getJSON('/searchBySchool', function(schoolsArr) {
    console.log("Got " + schoolsArr.length + " schools");
    $.each(schoolsArr, function(idx, school) {
      console.dir(school);
      // add a schoolBtn for each school;
      $('#searchBySchool').prepend(
        $('<div/>', {class:'schoolBtn',
                     id:   school._id + "-Btn",
                     text: school.name})
      );
      // add a coursesOfSchool div immediately following;
      $('#' + school._id + '-Btn').after(
        $('<div/>', {class:'coursesOfSchool',
                     id: school.name + '-Courses'})
      );
      // add the courses inside coursesOfSchool;
      $.each(school.courses, function(idx, course) {
        $('#' + school.name + '-Courses').append(
          $('<div/>', {id: course._id,
                       class: 'courseBtn',
                       text: course.title})
        );
      });
    });
  });
  

// =========================================================================
  // click on schoolBtn opens accordion and retrieves notes for all courses;
  $('#searchBySchool').on("click", ".schoolBtn", function() {
    // TODO: open school accordion here;
    var schoolID = this.id.slice(0, -4);
    console.log('fetching: /notesOfSchool/' + schoolID);

    if ($('#' + this.id + ' > div').length == 0) {
      console.log('children: ' + $('#' + this.id + ' > div').length);
      $.getJSON('/notesOfSchool/' + schoolID, function(coursesArr) {
        console.log('/notesOfSchool/'+schoolID);
        $.each(coursesArr[0].courses, function(idx, course) {
          if($('#' + course._id).next().class != "notesOfCourse"){ // if notes aren't all ready displayed
            var ulOfNotes = "<ul>";
            $.each(course.notes, function(idx, note){
              ulOfNotes += "<li>"+note.text + "</li>";
            });
            ulOfNotes += "</ul>"
            $('#' + course._id).after(
                $('<div/>', {class: "notesOfCourse"}).innerHTML =ulOfNotes
              );
          }
        });
      });
    }
  });
//================================= 
  
  $('#searchBySchool').on("click", ".courseBtn", function() {
    // open course accordion to display notes;
  });

  $('#notes-btn').click(function (event) { 
    $('#drop-area').hide();
    $('#searchBySchool').show();
  });
  
  var fileListHeaderDrawn = false;
  function nodeToString ( node ) {
    var tmpNode = document.createElement( "div" );
    tmpNode.appendChild( node.cloneNode( true ) );
    var str = tmpNode.innerHTML;
    tmpNode = node = null; // prevent memory leaks in IE
    return str;
  }

  $(function () {
    progressBarContainer = document.createElement("div"),
    progressBar = document.createElement("div");
    $('#file-list').fileupload({
      dataType: 'json',
      url: 'http://karmanotes.org:8080',
      done: function (e, data) {
          $.each(data.result, function (index, file) {
            fileList = document.getElementById("file-list");
            tr = document.createElement("tr");
            
            progressBarContainer.className = "progress progress-striped active";
            progressBar.className = "bar";
            progressBarContainer.appendChild(progressBar);

            if (fileListHeaderDrawn == false){
              headerRow = document.createElement("tr");
              headerRow.innerHTML = "<td><b>Name</b></td><td><b>Size</b></td><td><b>Progress</b></td>"
              fileList.appendChild(headerRow);
              fileListHeaderDrawn = true;
            }
              
            fileInfo = "<td>"+file.name +"</td>";
            fileInfo += "<td>"+ (Math.round(file.size/(100000))/10) + " MB</td>";
            fileInfo += "<td>" + nodeToString( progressBarContainer)+"</td>";
            tr.innerHTML = fileInfo;
            fileList.appendChild(tr);
          });
      },
      progress: function (e, data) {
        var progress = parseInt(data.loaded / data.total * 100, 10);
        progressBar.style.width = progress+"%";
        //alert(progressBar.style.width);
        if (progress == 100){
          progressBar.style.width = "0%";
          progressBarContainer.innerHTML = "Done";
        }
      } // end progress
    }); // end file list populating
  }); // end file drag-n-drop

}); // $(document).ready
</script>
</body> 
</html>